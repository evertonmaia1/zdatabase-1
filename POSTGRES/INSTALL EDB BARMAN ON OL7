+++++++++++++++++++++++++++++++++++++++++
+	      INSTALL EDB BARMAN ON OL7	      +
+++++++++++++++++++++++++++++++++++++++++

#CONFIGURE REPOSITORY
[root@oracleedbes ~]# yum -y install https://yum.enterprisedb.com/edbrepos/edb-repo-latest.noarch.rpm

[root@oracleedbes ~]# vim /etc/yum.repos.d/edb.repo
[edb]
name=EnterpriseDB RPMs $releasever - $basearch
baseurl=https://<USERNAME>:<PASSWORD>@yum.enterprisedb.com/edb/redhat/rhel-$releasever-$basearch
enabled=1
repo_gpgcheck=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/ENTERPRISEDB-GPG-KEY

[edb-testing]
name=EnterpriseDB Testing - Not For Production $releasever - $basearch
baseurl=https://<USERNAME>:<PASSWORD>@yum.enterprisedb.com/edb-testing/redhat/rhel-$releasever-$basearch
enabled=0
repo_gpgcheck=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/ENTERPRISEDB-GPG-KEY

#INSTALL EDB BARMAN CLI
[root@oracleedbes ~]# yum install -y barman-cli

#USER PROVISIONING
-bash-4.2$ /usr/edb/as13/bin/createuser --superuser --replication -P barman
Enter password for new role: 
Enter it again:

-bash-4.2$ /usr/edb/as13/bin/createuser --replication -P streaming_barman 
Enter password for new role: 
Enter it again: 

#ADD RULE TO PG_HBA FILE
-bash-4.2$ sed -i '$ a host   replication    streaming_barman   all 			md5' /var/lib/edb/as13/data/pg_hba.conf
-bash-4.2$ sed -i '$ a host   all            barman          	10.5.150.0/24           md5' /var/lib/edb/as13/data/pg_hba.conf
-bash-4.2$ /usr/edb/as13/bin/psql postgres
psql (13.3.7, server 13.3.7)
Type "help" for help.

postgres=# SELECT pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

#CREATE DATABASE DEMO AND IMPORT DUMP

-bash-4.2$ /usr/edb/as13/bin/psql postgres -c "CREATE DATABASE DEMO;"
CREATE DATABASE
-bash-4.2$ /usr/edb/as13/bin/psql -d demo -f /tmp/demo_small.sql 

#SETTING STREAMMING PARAMETERS
-bash-4.2$ /usr/edb/as13/bin/psql -d demo
psql (13.3.7, server 13.3.7)
Type "help" for help.

demo=# show max_wal_senders;
 max_wal_senders 
-----------------
 10
(1 row)

demo=# show max_replication_slots;
 max_replication_slots 
-----------------------
 10
(1 row)

#POSTEGRESQL CONNECTION

-bash-4.2$ /usr/edb/as13/bin/psql postgres
psql (13.3.7, server 13.3.7)
Type "help" for help.

postgres=# GRANT EXECUTE ON FUNCTION pg_start_backup(text, boolean, boolean) to barman;
GRANT
postgres=# GRANT EXECUTE ON FUNCTION pg_stop_backup() to barman;
GRANT
postgres=# GRANT EXECUTE ON FUNCTION pg_stop_backup(boolean, boolean) to barman;
GRANT
postgres=# GRANT EXECUTE ON FUNCTION pg_switch_wal() to barman;
GRANT
postgres=# GRANT EXECUTE ON FUNCTION pg_create_restore_point(text) to barman;
GRANT
postgres=# GRANT pg_read_all_settings TO barman;
GRANT ROLE
postgres=# GRANT pg_read_all_stats TO barman;
GRANT ROLE
postgres=# \q

#INSTALL BARMAN AND CONFIGURE

[root@oracleedbes ~]# yum install -y barman

[root@oracleedbes ~]# cat <<'EOF' >> /etc/barman.d/pg.conf
[oracleedbes.appsdba.info]
description =  "Example of PostgreSQL Database (Streaming-Only)"
conninfo = host=oracleedbes.appsdba.info user=barman dbname=demo
streaming_conninfo = host=oracleedbes.appsdba.info user=streaming_barman dbname=demo
backup_method = postgres
streaming_archiver = on
slot_name = barman
create_slot = auto
EOF

[root@oracleedbes ~]# su - barman
-bash-4.2$

#TEST CONNECTION DATABASE 
-bash-4.2$ /usr/edb/as13/bin/psql -h oracleedbes.appsdba.info -p 5444 -d postgres -U barman -c 'SELECT version()'
Password for user barman: 
                                                                    version                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------
 PostgreSQL 13.3 (EnterpriseDB Advanced Server 13.3.7) on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit
(1 row)

#CONFIGURE POSTGRESQL CONNECTION PASSWORD FILE

-bash-4.2$ cat <<'EOF' >>~/.pgpass
oracleedbes.appsdba.info:5444:demo:barman:enterprisedb
oracleedbes.appsdba.info:5444:demo:streaming_barman:enterprisedb
EOF
-bash-4.2$ chmod 0600 ~/.pgpass

-bash-4.2$ barman cron
Starting WAL archiving for server oracleedbes
Starting streaming archiver for server oracleedbes

-bash-4.2$ barman check oracleedbes.appsdba.info
Server SEPOS-371506:
	WAL archive: FAILED (please make sure WAL shipping is setup)
	PostgreSQL: FAILED
	directories: OK
	retention policy settings: OK
	backup maximum age: OK (no last_backup_maximum_age provided)
	compression settings: OK
	failed backups: OK (there are 0 failed backups)
	minimum redundancy requirements: OK (have 0 backups, expected at least 0)
	pg_basebackup: OK
	pg_basebackup compatible: FAILED (PostgreSQL version: None, pg_basebackup version: 13.3.7)
	systemid coherence: OK (no system Id available)
	pg_receivexlog: FAILED
	pg_receivexlog compatible: FAILED (PostgreSQL version: None, pg_receivexlog version: None)
	receive-wal running: FAILED (See the Barman log file for more details)
	archiver errors: OK
